os: osx
osx_image: xcode12.2
language: swift

deploy:
  provider: releases
  script: pod trunk push --verbose --allow-warnings | tee pod.log | ruby -e 'ARGF.each{ print "." }'
  on:
    tags: true
branches:
  only:
    - master
    - /^\d+\.\d+\.\d+$/
stages:
  - name: lint
    if: NOT branch =~ ^\d+\.\d+\.\d+$
  - name: deploy
    if: branch =~ ^\d+\.\d+\.\d+$
jobs:
  include:

    - &pod
      stage: lint
      osx_image: xcode12.2
      env: SWIFT=5.2
      cache: cocoapods
      install: gem install cocoapods -v '~> 1.7.0'
      script: pod lib lint Kuru.podspec --allow-warnings --fail-fast --swift-version=$SWIFT

    - name: '`pod trunk push`'
      stage: deploy
      install: gem install cocoapods -v '~> 1.7.0'
      before_script: |
        sed -i '' "s/s.version = '0.0.1'/s.version = '$TRAVIS_TAG'/g" Kuru.podspec
      script: |
        set -exo pipefail
        pod trunk push --verbose --allow-warnings | tee pod.log | ruby -e 'ARGF.each{ print "." }'
      # ^^ pipe because Travis times us out if there is no output
      # AND `pod` defaults to hardly any output
      # BUT `--verbose` generates so much output that Travis kills our script due to *too much* output!
      # --allow-warnings because Bolts generates warnings and CocoaPods fails you even if your deps emit warnings
      after_failure: cat pod.log | grep error